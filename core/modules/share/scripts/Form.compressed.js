ScriptLoader.load("TabPane","Toolbar","Validator","RichEditor","ModalBox");var Form=new Class({Implements:[Energine.request],initialize:function(a){Asset.css("form.css");this.componentElement=$(a);this.singlePath=this.componentElement.getProperty("single_template");this.form=this.componentElement.getParent("form").addClass("form");this.tabPane=new TabPane(this.componentElement,{});this.validator=new Validator(this.form,this.tabPane);this.richEditors=[],this.uploaders=[],this.textBoxes=[],this.dateControls=[];this.form.getElements("textarea.richEditor").each(function(b){this.richEditors.push(new Form.RichEditor(b,this,this.fallback_ie))},this);this.componentElement.getElements(".uploader").each(function(b){this.uploaders.push(new Form.Uploader(b,this,"upload/"))},this);(this.componentElement.getElements(".inp_date")||[]).extend((this.componentElement.getElements(".inp_datetime")||[])).each(function(b){var c=!b.getParent(".field").hasClass("required");this.dateControls.push((b.hasClass("inp_date")?Energine.createDatePicker(b,c):Energine.createDateTimePicker(b,c)))},this);if(this.componentElement.getElement("#attached_files")){(function(){new Form.AttachmentPane(this)}).delay(300,this)}this.componentElement.getElements(".pane").setStyles({border:"1px dotted #777",overflow:"auto"})},attachToolbar:function(d){this.toolbar=d;var b=this.componentElement.getElement(".e-pane-b-toolbar");if(b){b.adopt(this.toolbar.getElement())}else{this.componentElement.adopt(this.toolbar.getElement())}var c;if(c=this.toolbar.getControlById("after_save_action")){var a=Cookie.read("after_add_default_action");if(a){c.setSelected(a)}}d.bindTo(this)},save:function(){this.richEditors.each(function(a){a.onSaveForm()});if(!this.validator.validate()){return false}this.request(this.singlePath+"save",this.form.toQueryString(),this.processServerResponse.bind(this))},processServerResponse:function(b){if(b&&(b.mode=="insert")){var a;if(a=this.toolbar.getControlById("after_save_action")){Cookie.write("after_add_default_action",a.getValue(),{path:new URI(Energine.base).get("directory"),duration:1});b.afterClose=a.getValue()}}ModalBox.setReturnValue(b);this.close()},close:function(){ModalBox.close()},openFileLib:function(a){var b=$($(a).getProperty("link")).get("value");if(b==""){b=null}ModalBox.open({url:this.singlePath+"file-library/",extraData:b,onClose:function(c){if(c){a=$(a);$(a.getProperty("link")).value=c.upl_path;if(image=$(a.getProperty("preview"))){image.setProperty("src",c.upl_path)}}}})}});Form.Uploader=new Class({initialize:function(a,b,c){if(!(this.element=$(a))){return}this.form=b;this.swfUploader=new Swiff.Uploader({path:"scripts/Swiff.Uploader.swf",url:this.form.singlePath+c+"?json",verbose:(Energine.debug)?true:false,queued:false,multiple:false,target:this.element,instantStart:true,appendCookieData:false,data:{NRGNSID:Cookie.read("NRGNSID"),path:($type(ModalBox.getExtraData())=="string")?ModalBox.getExtraData():"",element:this.element.getProperty("nrgn:input")},typeFilter:{"All files (*.*)":"*.*","Images (*.jpg, *.jpeg, *.gif, *.png)":"*.jpg; *.jpeg; *.gif; *.png","Flash video (*.flv)":"*.flv"},onFileComplete:this.afterUpload.bind(this),onFileProgress:function(d){b.form.getElementById("indicator").set("text",d.progress.percentLoaded+"%")},onFileOpen:function(){b.form.getElementById("loader").removeClass("hidden");b.form.getElementById("indicator").removeClass("hidden")},onComplete:function(){b.form.getElementById("loader").addClass("hidden");b.form.getElementById("indicator").addClass("hidden")},onFail:this.handleError.bind(this),onSelectFail:this.handleError.bind(this)})},afterUpload:function(a){this._show_preview(a)},handleError:function(){this.form.validator.showError(this.element,"При загрузке файла произошла ошибка")},_show_preview:function(c){if(!c.response.error){var d=JSON.decode(c.response.text,true);var e,b,a;if((e=$(d.element+"_preview"))&&(b=$(d.element))){b.set("value",d.file);if($("upl_name")&&(!$("upl_name").get("value"))){$("upl_name").set("value",d.title)}if(!(a=e.getElement("img"))){a=new Element("img",{border:0}).inject(e)}a.setProperty("src",d.preview)}}else{this.form.validator.showError(this.element,"При загрузке файла произошла ошибка")}},removeFilePreview:function(a,c){var b;$(a).value="";if(b=$(a+"_preview")){b.setProperty("src","")}if(b=$(a+"_link")){b.set("html","")}return false}});Form.Sked=new Class({Implements:Options,options:{handlers:{"delete":this.delItem,add:$empty},tableName:"items",pk:"target"},initialize:function(b,a){this.setOptions(a);this.element=$(b);this.element.getElementById("add_item").addEvent("click",function(c){Energine.cancelEvent(c);this.options.handlers.add()}.bind(this));this.element.getElements(".deleteItem").addEvent("click",function(c){Energine.cancelEvent(c);this.options.deleteFunc.run($(c.target).getProperty("target"))}.bind(this));this.element.getElements(".upItem").addEvent("click",function(c){Energine.cancelEvent(c);this.upItem($(c.target).getProperty("target"))}.bind(this));this.element.getElements(".downItem").addEvent("click",function(c){Energine.cancelEvent(c);this.downItem($(c.target).getProperty("target"))}.bind(this))},upItem:function(a){this._moveItem(a,"up")},downItem:function(a){this._moveItem(a,"down")},_moveItem:function(e,d){var b,c,a;if(b=$("row_"+e)){if(d=="up"){c=b.getPrevious();a="before"}else{c=b.getNext();a="after"}if(c){b.inject(c,a)}}this._zebraRows()},_zebraRows:function(){this.element.getElements("tbody tr").removeClass("even");this.element.getElements("tbody tr:even").addClass("even")},insertItem:function(d){var a,b=this.options.pk,c=new Element("tr");if(a=$("empty_row")){a.dispose()}if(!$("row_"+d[b])){c.setProperty("id","row_"+d[b]);$H(d).each(function(f,e){c.grab(((e==b)?this._buildPKColumn(f):this._buildColumn(f)))}.bind(this));this.element.getElement("tbody").grab(c);this._zebraRows()}},_buildPKColumn:function(a){return new Element("td").adopt([new Element("button",{type:"button",events:{click:function(b){this.delItem(a)}.bind(this)}}).set("text",Energine.translations.get("BTN_DEL_ITEM")),new Element("button",{type:"button",events:{click:function(b){this.upItem(a)}.bind(this)}}).set("text",Energine.translations.get("BTN_UP")),new Element("button",{type:"button",events:{click:function(b){this.downItem(a)}.bind(this)}}).set("text",Energine.translations.get("BTN_DOWN")),new Element("input",{name:this.options.tableName+"["+this.options.pk+"][]",type:"hidden",value:a})])},_buildColumn:function(a){return new Element("td").set("html",a)},delItem:function(a){$("row_"+a).dispose();if(this.element.getElement("tbody").getChildren().length==0){this.element.getElement("tbody").adopt(new Element("tr",{id:"empty_row"}).adopt(new Element("td",{colspan:"3"}).set("html",Energine.translations.get("MSG_NO_ITEMS"))))}this._zebraRows()}});Form.AttachmentPane=new Class({Extends:Form.Uploader,initialize:function(a){if(!$("add_attachment")||!$("insert_attachment")){return}this.parent($("add_attachment"),a,"put/");$("insert_attachment").addEvent("click",function(b){Energine.cancelEvent(b);ModalBox.open({url:a.singlePath+"file-library/media/",onClose:this._insertRow.bind(this)})}.bind(this));this.form.componentElement.getElements(".delete_attachment").addEvent("click",function(b){Energine.cancelEvent(b);this.delAttachment($(b.target).getProperty("upl_id"))}.bind(this));this.form.componentElement.getElements(".up_attachment").addEvent("click",function(b){Energine.cancelEvent(b);this.upAttachment($(b.target).getProperty("upl_id"))}.bind(this));this.form.componentElement.getElements(".down_attachment").addEvent("click",function(b){Energine.cancelEvent(b);this.downAttachment($(b.target).getProperty("upl_id"))}.bind(this))},afterUpload:function(a){if(!a.response.error){var b=JSON.decode(a.response.text);this._insertRow(b)}},upAttachment:function(a){this._moveAttachment(a,"up")},downAttachment:function(a){this._moveAttachment(a,"down")},_moveAttachment:function(b,e){var c,d,a;if(c=$("row_"+b)){if(e=="up"){d=c.getPrevious();a="before"}else{d=c.getNext();a="after"}if(d){c.inject(d,a)}}this._zebraRows()},_zebraRows:function(){document.getElements("#attached_files tbody tr").removeClass("even");document.getElements("#attached_files tbody tr:even").addClass("even")},_insertRow:function(a){if(a){var c=a;var b;if(b=$("empty_row")){b.dispose()}if(!$("row_"+c.upl_id)){document.getElement("#attached_files tbody").adopt(new Element("tr",{id:"row_"+c.upl_id}).adopt([new Element("td").adopt([new Element("button",{type:"button",events:{click:function(d){this.delAttachment(c.upl_id)}.bind(this)}}).set("text",Energine.translations.get("BTN_DEL_FILE")),new Element("button",{type:"button",events:{click:function(d){this.upAttachment(c.upl_id)}.bind(this)}}).set("text",Energine.translations.get("BTN_UP")),new Element("button",{type:"button",events:{click:function(d){this.downAttachment(c.upl_id)}.bind(this)}}).set("text",Energine.translations.get("BTN_DOWN")),new Element("input",{name:"uploads[upl_id][]",type:"hidden",value:c.upl_id})]),new Element("td").set("html",c.upl_name),new Element("td").adopt(new Element("a",{href:c.upl_path,target:"blank"}).adopt((!(["image","video"].contains(c.upl_mime_type)))?new Element("span").set("html",c.upl_path):new Element("img",{src:c.upl_data.thumb,border:"0"})))]))}}this._zebraRows()},delAttachment:function(a){if($("row_"+a)){$("row_"+a).dispose()}else{$("row_").dispose()}if(document.getElement("#attached_files tbody").getChildren().length==0){document.getElement("#attached_files tbody").adopt(new Element("tr",{id:"empty_row"}).adopt(new Element("td",{colspan:"3"}).set("html",Energine.translations.get("MSG_NO_ATTACHED_FILES"))))}this._zebraRows()}});Form.Label={setLabel:function(a){var b=name=segment=segmentObject="";if(typeof(a)!="undefined"){if(a){b=a.smap_id;name=a.smap_name;segment=a.smap_segment}$(this.obj.getProperty("hidden_field")).value=b;$(this.obj.getProperty("span_field")).innerHTML=name;if(segmentObject=$("smap_pid_segment")){segmentObject.innerHTML=segment}Cookie.write("last_selected_smap",JSON.encode({id:b,name:name,segment:segment}),{path:new URI(Energine.base).get("directory"),duration:1})}},prepareLabel:function(a,b){if(!arguments[1]){b=false}if(this.obj=$("sitemap_selector")){this.obj.addEvent("click",this.showTree.pass(a,this));if(b){this.restoreLabel()}}},showTree:function(a){ModalBox.open({url:this.singlePath+a,onClose:this.setLabel.bind(this)})},restoreLabel:function(){var a=Cookie.read("last_selected_smap");if(this.obj&&a){a=JSON.decode(a);$(this.obj.getProperty("hidden_field")).value=a.id;$(this.obj.getProperty("span_field")).innerHTML=a.name;if(segmentObject=$("smap_pid_segment")){segmentObject.innerHTML=a.segment}}}};Form.RichEditor=new Class({Extends:RichEditor,initialize:function(a,c,b){this.fallback_ie=b;if(!Energine.supportContentEdit){return}this.textarea=$(a);this.form=c;if(Energine.supportContentEdit&&!this.fallback_ie){this.hidden=new Element("input").setProperty("name",this.textarea.name).setProperties({"class":"richEditorValue",type:"hidden",value:"","nrgn:pattern":this.textarea.getProperty("nrgn:pattern"),"nrgn:message":this.textarea.getProperty("nrgn:message")}).injectBefore(this.textarea);this.area=new Element("div").addEvent("blur",function(){this.hidden.value=this.area.innerHTML;this.hidden.fireEvent("blur")}.bind(this)).setProperties({componentPath:this.form.singlePath}).addClass("richEditor").setStyles({clear:"both",overflow:"auto"}).set("html",this.textarea.value);if(this.textarea.hasClass("half")){this.area.addClass("half")}if(this.textarea.hasClass("quarter")){this.area.addClass("quarter")}this.area.replaces(this.textarea);this.area.addEvent("keydown",function(){this.hidden.fireEvent("keydown")}.bind(this));this.pasteArea=new Element("div").setStyles({visibility:"hidden",width:"0",height:"0","font-size":"0","line-height":"0"}).injectInside(document.body);if(Browser.Engine.trident){this.area.onpaste=this.processPasteFF.bindWithEvent(this)}else{if(Browser.Engine.gecko){this.area.onpaste=this.processPasteFF.bindWithEvent(this)}}this.area.contentEditable="true"}else{this.area=this.textarea.setProperty("componentPath",this.form.singlePath)}this.area.setProperty("single_template",this.form.singlePath);this.toolbar=new Toolbar(this.textarea.name);this.toolbar.appendControl(new Toolbar.Button({id:"bold",icon:"images/toolbar/bold.gif",title:Energine.translations.get("BTN_BOLD"),action:"bold"}));this.toolbar.appendControl(new Toolbar.Button({id:"italic",icon:"images/toolbar/italic.gif",title:Energine.translations.get("BTN_ITALIC"),action:"italic"}));this.toolbar.appendControl(new Toolbar.Button({id:"olist",icon:"images/toolbar/olist.gif",title:Energine.translations.get("BTN_OL"),action:"olist"}));this.toolbar.appendControl(new Toolbar.Button({id:"ulist",icon:"images/toolbar/ulist.gif",title:Energine.translations.get("BTN_UL"),action:"ulist"}));this.toolbar.appendControl(new Toolbar.Button({id:"link",icon:"images/toolbar/link.gif",title:Energine.translations.get("BTN_HREF"),action:"link"}));this.toolbar.appendControl(new Toolbar.Separator({id:"sep1"}));this.toolbar.appendControl(new Toolbar.Button({id:"left",icon:"images/toolbar/justifyleft.gif",title:Energine.translations.get("BTN_ALIGN_LEFT"),action:"alignLeft"}));this.toolbar.appendControl(new Toolbar.Button({id:"center",icon:"images/toolbar/justifycenter.gif",title:Energine.translations.get("BTN_ALIGN_CENTER"),action:"alignCenter"}));this.toolbar.appendControl(new Toolbar.Button({id:"right",icon:"images/toolbar/justifyright.gif",title:Energine.translations.get("BTN_ALIGN_RIGHT"),action:"alignRight"}));this.toolbar.appendControl(new Toolbar.Button({id:"justify",icon:"images/toolbar/justifyall.gif",title:Energine.translations.get("BTN_ALIGN_JUSTIFY"),action:"alignJustify"}));if(Energine.supportContentEdit&&!this.fallback_ie){this.toolbar.appendControl(new Toolbar.Separator({id:"sep2"}));this.toolbar.appendControl(new Toolbar.Button({id:"source",icon:"images/toolbar/source.gif",title:Energine.translations.get("BTN_VIEWSOURCE"),action:"showSource"}))}this.toolbar.appendControl(new Toolbar.Separator({id:"sep3"}));this.toolbar.appendControl(new Toolbar.Button({id:"filelib",icon:"images/toolbar/filemngr.gif",title:Energine.translations.get("BTN_FILE_LIBRARY"),action:"fileLibrary"}));this.toolbar.appendControl(new Toolbar.Button({id:"imgmngr",icon:"images/toolbar/image.gif",title:Energine.translations.get("BTN_INSERT_IMAGE"),action:"imageManager"}));$pick(this.area,this.textarea).getParent().grab(this.toolbar.getElement(),"top");this.toolbar.element.setStyle("width","650px");this.toolbar.bindTo(this)},onSaveForm:function(){if(!Energine.supportContentEdit||this.fallback_ie){return}this.hidden.value=this.area.innerHTML},showSource:function(){this.sourceMode=!this.sourceMode;if(this.sourceMode){this.fallback_ie=true;this.textarea.value=this.area.innerHTML;this.textarea.replaces(this.area)}else{this.fallback_ie=false;this.area.set("html",this.cleanMarkup(this.form.singlePath,this.textarea.value,false));this.area.replaces(this.textarea)}},disable:function(){if(Browser.Engine.trident){this.area.contentEditable="false"}else{this.area.disabled=true}this.toolbar.disableControls()},enable:function(){if(Browser.Engine.trident){this.area.contentEditable="true"}else{this.area.disabled=false}this.toolbar.enableControls()}});